#!/bin/bash
# Runs the instances of the examples folder.

IN_PATH=$SUNNY_HOME/test/examples
OZN=$IN_PATH/tmp.ozn
PFOLIO='g12cpx,g12lazyfd,g12fd,g12cbc'
BACKUP='g12cpx'
PROC=4
OUT=$IN_PATH/out
ERR=$IN_PATH/err
TIMEOUT=10
OUTPUT=$IN_PATH/output.log
ERRORS=$IN_PATH/errors.log
cd $IN_PATH
rm $OUTPUT $ERRORS 2>/dev/null

for m in `ls *.mzn`
do
  echo "Solving $m....."
  if 
    [[ $m == 'domino.mzn' ]]
  then
    for d in domino.1.dzn domino.2.dzn
    do
      mzn2fzn $m $d --output-ozn-to-file $OZN
      cmd="sunny-cp -p $PROC -P $PFOLIO -b $BACKUP -T $TIMEOUT $m $d"
      $cmd 1>$OUT 2>$ERR
      ret=$?
      cat $OUT | solns2out $OZN | solns2dzn -l
      echo '********** Instance: '$cmd >> $OUTPUT
      echo '********** Instance: '$cmd >> $ERRORS
      cat $OUT >> $OUTPUT
      cat $ERR >> $ERRORS
      if
	[ $ret -ne 0 ]
      then
	echo "Error while solving $m!!! Test aborted."
	echo "Have a look at the log files $OUTPUT and $ERRORS"
	exit $ret
      fi
    done
  else
    mzn2fzn $m --output-ozn-to-file $OZN
    cmd="sunny-cp -p $PROC -P $PFOLIO -b $BACKUP -T $TIMEOUT $m"
    $cmd 1>$OUT 2>$ERR
    ret=$?
    cat $OUT | solns2out $OZN | solns2dzn -l
    echo '********** Instance: '$cmd >> $OUTPUT
    echo '********** Instance: '$cmd >> $ERRORS
    cat $OUT >> $OUTPUT
    cat $ERR >> $ERRORS
    if
      [ $ret -ne 0 ]
    then
      echo "Error while solving $m!!! Test aborted."
      echo "Have a look at the log files $OUTPUT and $ERRORS"
      rm *.fzn
      exit $ret
    fi
  fi
  echo "$m processed!"
  echo -e "==========\n"
done
rm *.fzn
rm $OZN $OUT $ERR
echo "All the examples processed without errors."
echo "Have a look at the log files $OUTPUT and $ERRORS"
